generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                    String                 @id @default(cuid())
  name                  String
  code                  String                 @unique
  address               String?
  logoUrl               String?
  vatNumber             String?
  productionStages      Json?
  settings              Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  auditLogs             AuditLog[]
  clients               Client[]
  documents             Document[]
  employees             Employee[]
  inquiries             Inquiry[]
  inventoryItems        InventoryItem[]
  invoices              Invoice[]
  materialRequests      MaterialRequest[]
  projects              Project[]
  purchaseOrders        PurchaseOrder[]
  quotations            Quotation[]
  subcontractWorkOrders SubcontractWorkOrder[]
  users                 User[]
  vendors               Vendor[]
  vendorQuotes          VendorQuote[]
  grns                  GRN[]
  materialIssues        MaterialIssue[]
  wastageRecords        WastageRecord[]
  productionJobs        ProductionJob[]
  qcRecords             QCRecord[]
  reworkJobs            ReworkJob[]
  returnRecords         ReturnRecord[]
  notifications         Notification[]
  deliveryNotes         DeliveryNote[]
  vehicles              Vehicle[]
  drivers               Driver[]
}

model User {
  id        String   @id @default(cuid())
  tenantId  String?
  name      String
  email     String   @unique
  password  String
  role      Role
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
}

model Client {
  id                String          @id @default(cuid())
  tenantId          String
  name              String
  companyName       String?
  email             String?
  phone             String?
  phone2            String?
  address           String?
  city              String?
  state             String?
  country           String?
  zipCode           String?
  vatNumber         String?
  gstin             String?
  panNumber         String?
  taxId             String?
  website           String?
  registrationNumber String?
  paymentTerms      String?
  creditLimit       Float?
  notes             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  isActive          Boolean         @default(true)
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveryNotes     DeliveryNote[]
  inquiries         Inquiry[]
  invoices          Invoice[]
  projects          Project[]
  quotations        Quotation[]
  returnRecords     ReturnRecord[]
  purchaseOrders    PurchaseOrder[]
}

model Inquiry {
  id          String      @id @default(cuid())
  tenantId    String
  clientId    String
  source      String
  projectType String
  location    String?
  status      String
  assignedTo  String?
  notes       String?
  visitDate   DateTime?
  followUps   Json?
  attachments Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  isActive    Boolean     @default(true)
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quotations  Quotation[]
}

model Quotation {
  id              String          @id @default(cuid())
  tenantId        String
  inquiryId       String?
  clientId        String
  quotationNumber String          @unique
  status          String
  validityDays    Int?
  preparedBy      String
  approvedBy      String?
  discount        Float?
  totalAmount     Float?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  attachments     Json?
  notes           String?
  rejectedAt      DateTime?
  rejectedBy      String?
  sentAt          DateTime?
  sentBy          String?
  subtotal        Float?
  vatAmount       Float?
  vatPercent      Float?
  projects        Project[]
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  inquiry         Inquiry?        @relation(fields: [inquiryId], references: [id])
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quotationLines  QuotationLine[]
}

model QuotationLine {
  id           String    @id @default(cuid())
  quotationId  String
  itemName     String
  width        Float?
  height       Float?
  quantity     Int
  areaSqm      Float?
  runningMeter Float?
  unitRate     Float
  total        Float
  systemType   String
  materialList Json?
  labourCost   Float?
  overheads    Float?
  remarks      String?
  quotation    Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model Project {
  id                    String                 @id @default(cuid())
  tenantId              String
  projectCode           String                 @unique
  name                  String
  clientId              String
  quotationId           String?
  type                  String
  startDate             DateTime?
  endDate               DateTime?
  status                String
  plannedCost           Float?
  actualCost            Float?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  notes                 String?
  deliveryNotes         DeliveryNote[]
  invoices              Invoice[]
  materialRequests      MaterialRequest[]
  productionJobs        ProductionJob[]
  client                Client                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quotation             Quotation?             @relation(fields: [quotationId], references: [id])
  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders        PurchaseOrder[]
  subGroups             SubGroup[]
  subcontractWorkOrders SubcontractWorkOrder[]
}

model SubGroup {
  id                    String                 @id @default(cuid())
  projectId             String
  name                  String
  plannedArea           Float?
  plannedQty            Float?
  plannedMaterial       Json?
  plannedLabour         Json?
  actualArea            Float?
  actualQty             Float?
  actualMaterial        Json?
  actualLabour          Json?
  dispatchedQty         Float                  @default(0)
  completed             Boolean                @default(false)
  deliveryNotes         DeliveryNote[]
  materialRequests      MaterialRequest[]
  productionJobs        ProductionJob[]
  purchaseOrders        PurchaseOrder[]
  project               Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subcontractWorkOrders SubcontractWorkOrder[]
}

model ProductionJob {
  id                  String               @id @default(cuid())
  tenantId            String
  projectId           String
  subGroupId          String
  jobCardNumber       String               @unique
  stage               String
  stageIndex          Int?
  status              String // NOT_STARTED | IN_PROGRESS | COMPLETED | REWORK | CANCELLED
  plannedHours        Float?
  actualHours         Float?               @default(0)
  plannedQty          Float?
  actualQty           Float?               @default(0)
  materialConsumption Json?
  assignedTo          String?
  createdBy           String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subGroup            SubGroup             @relation(fields: [subGroupId], references: [id], onDelete: Cascade)
  productionStageLogs ProductionStageLog[]
  materialIssues      MaterialIssue[]
  labourLogs          LabourLog[]
  qcRecords           QCRecord[]
  reworkJobs          ReworkJob[]
  tenant              Tenant               @relation(fields: [tenantId], references: [id])
}

model ProductionStageLog {
  id              String        @id @default(cuid())
  productionJobId String
  tenantId        String
  stage           String
  startedAt       DateTime?
  completedAt     DateTime?
  performedBy     String?
  hoursLogged     Float?
  outputQty       Float?
  notes           String?
  photos          Json?
  qcStatus        String? // PASS | FAIL | NA
  createdAt       DateTime      @default(now())
  productionJob   ProductionJob @relation(fields: [productionJobId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id                String             @id @default(cuid())
  tenantId          String
  itemName          String
  itemCode          String?            @unique
  category          String?
  unit              String
  openingQty        Float              @default(0)
  availableQty      Float              @default(0)
  reservedQty       Float              @default(0)
  reorderLevel      Float?
  systemItem        Boolean            @default(true)
  uom               String?
  lastPurchaseRate  Float?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  poLines           POLine[]
  stockTransactions StockTransaction[]
  wastageRecords    WastageRecord[]
  deliveryNoteItems DeliveryNoteItem[]
}

model StockTransaction {
  id            String        @id @default(cuid())
  tenantId      String
  itemId        String
  type          String // IN | OUT | ADJUSTMENT | TRANSFER
  referenceType String // GRN | ISSUE | RETURN | ADJUST | PO | DN | RESERVE
  referenceId   String?
  qty           Float
  rate          Float?
  balanceAfter  Float
  batchNo       String?
  remarks       String?
  createdBy     String?
  createdAt     DateTime      @default(now())
  item          InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model MaterialIssue {
  id            String        @id @default(cuid())
  tenantId      String
  jobId         String
  projectId     String?
  subGroupId    String?
  issuedBy      String
  issuedAt      DateTime      @default(now())
  items         Json // [{ itemId, qty, uom, wastage, remarks }]
  createdAt     DateTime      @default(now())
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productionJob ProductionJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
}

model LabourLog {
  id              String        @id @default(cuid())
  productionJobId String
  employeeId      String
  tenantId        String
  date            DateTime
  hours           Float
  overtime        Float?
  remarks         String?
  createdAt       DateTime      @default(now())
  productionJob   ProductionJob @relation(fields: [productionJobId], references: [id], onDelete: Cascade)
}

model QCRecord {
  id              String         @id @default(cuid())
  tenantId        String
  productionJobId String?
  deliveryNoteId  String?
  inspectorId     String
  stage           String?
  qcStatus        String // PASS | FAIL | NA
  inspectedAt     DateTime       @default(now())
  defects         Json? // [{desc, severity, photoDocId}]
  remarks         String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  productionJob   ProductionJob? @relation(fields: [productionJobId], references: [id], onDelete: Cascade)
  deliveryNote    DeliveryNote?  @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
}

model ReworkJob {
  id                    String         @id @default(cuid())
  tenantId              String
  sourceProductionJobId String?
  sourceDNId            String?
  assignedTo            String?
  createdBy             String
  status                String // OPEN | IN_PROGRESS | COMPLETED | CANCELLED
  expectedHours         Float?
  actualHours           Float?
  notes                 String?
  materialNeeded        Json? // [{itemId, qty}]
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  sourceProductionJob   ProductionJob? @relation(fields: [sourceProductionJobId], references: [id])
  sourceDN              DeliveryNote?  @relation(fields: [sourceDNId], references: [id])
  tenant                Tenant         @relation(fields: [tenantId], references: [id])
}

model ReturnRecord {
  id           String       @id @default(cuid())
  tenantId     String
  dnId         String
  clientId     String
  reason       String
  items        Json // [{dnLineId, itemId, qty, remarks}]
  status       String // PENDING | INSPECTED | ACCEPTED | REJECTED
  inspectedBy  String?
  inspectedAt  DateTime?
  outcome      String? // REWORK | SCRAP | ACCEPT_RETURN
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deliveryNote DeliveryNote @relation(fields: [dnId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  tenantId  String?
  userId    String?
  type      String // QC_FAIL | RETURN_CREATED | REWORK_CREATED | etc.
  title     String
  message   String
  read      Boolean  @default(false)
  link      String? // URL to related entity
  metadata  Json? // Additional data
  createdAt DateTime @default(now())
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model WastageRecord {
  id         String        @id @default(cuid())
  tenantId   String
  itemId     String
  jobId      String?
  qty        Float
  reason     String?
  recordedBy String
  recordedAt DateTime      @default(now())
  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item       InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model PurchaseOrder {
  id                String           @id @default(cuid())
  tenantId          String
  poNumber          String           @unique
  vendorId          String
  clientId          String?
  materialRequestId String?
  projectId         String?
  subGroupId        String?
  status            String
  totalAmount       Float
  createdBy         String
  approvedBy        String?
  approvedAt        DateTime?
  sentBy            String?
  sentAt            DateTime?
  deliveryDate      DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  grns              GRN[]
  poLines           POLine[]
  materialRequest   MaterialRequest? @relation(fields: [materialRequestId], references: [id])
  project           Project?         @relation(fields: [projectId], references: [id])
  subGroup          SubGroup?        @relation(fields: [subGroupId], references: [id])
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendor            Vendor           @relation(fields: [vendorId], references: [id])
  client            Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
}

model POLine {
  id              String         @id @default(cuid())
  purchaseOrderId String
  itemId          String?
  description     String
  qty             Float
  unit            String
  unitRate        Float
  amount          Float
  item            InventoryItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
  purchaseOrder   PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model GRN {
  id              String        @id @default(cuid())
  tenantId        String
  purchaseOrderId String
  grnNumber       String        @unique
  receivedDate    DateTime      @default(now())
  receivedBy      String
  items           Json
  documents       Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model DeliveryNote {
  id            String                  @id @default(cuid())
  tenantId      String
  dnNumber      String                  @unique
  projectId     String
  subGroupId    String?
  clientId      String
  address       String
  status        String                  // DRAFT | LOADING | DISPATCHED | DELIVERED | RETURNED | CANCELLED
  vehicleId     String?
  driverId      String?
  dispatchedAt  DateTime?
  deliveredAt   DateTime?
  remarks       String?
  createdBy     String
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  items         DeliveryNoteItem[]
  documents     Json?
  qcRecords     QCRecord[]
  returns       ReturnRecord[]
  tracking      DeliveryTracking[]
  acknowledgement DeliveryAcknowledgement?
  client        Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project       Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subGroup      SubGroup?               @relation(fields: [subGroupId], references: [id])
  vehicle       Vehicle?                @relation(fields: [vehicleId], references: [id])
  driver        Driver?                 @relation(fields: [driverId], references: [id])
  tenant        Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reworkJobs    ReworkJob[]
}

model DeliveryNoteItem {
  id             String         @id @default(cuid())
  dnId           String
  tenantId       String
  productionJobId String?
  itemId         String?
  description    String
  qty            Float
  loadedQty      Float?
  deliveredQty   Float?
  uom            String?
  remarks        String?
  deliveryNote   DeliveryNote   @relation(fields: [dnId], references: [id], onDelete: Cascade)
  inventoryItem  InventoryItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)
}

model Vehicle {
  id          String         @id @default(cuid())
  tenantId    String
  numberPlate String
  type        String         // Pickup, Truck, Tempo, etc.
  capacity    Float?
  status      String         // AVAILABLE | IN_USE | MAINTENANCE
  driverId    String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driver      Driver?        @relation(fields: [driverId], references: [id])
  deliveryNotes DeliveryNote[]
}

model Driver {
  id          String         @id @default(cuid())
  tenantId    String
  name        String
  phone       String
  licenseNo   String?
  status      String         // ACTIVE | INACTIVE
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicles    Vehicle[]
  deliveryNotes DeliveryNote[]
}

model DeliveryTracking {
  id          String         @id @default(cuid())
  tenantId    String
  dnId        String
  location    String?
  latitude    Float?
  longitude   Float?
  timestamp   DateTime       @default(now())
  remarks     String?
  deliveryNote DeliveryNote  @relation(fields: [dnId], references: [id], onDelete: Cascade)
}

model DeliveryAcknowledgement {
  id            String         @id @default(cuid())
  tenantId      String
  dnId          String         @unique
  receivedBy    String?
  signatureDocId String?
  sitePhotos    Json?          // photo docIds
  remarks       String?
  acknowledgedAt DateTime       @default(now())
  deliveryNote  DeliveryNote   @relation(fields: [dnId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  tenantId      String
  projectId     String
  clientId      String
  type          String
  subtotal      Float
  discount      Float?
  vatPercent    Float?
  vatAmount     Float?
  total         Float
  status        String
  createdAt     DateTime      @default(now())
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoiceLines  InvoiceLine[]
}

model InvoiceLine {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  qty         Float
  unitRate    Float
  total       Float
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Employee {
  id             String          @id @default(cuid())
  tenantId       String
  name           String
  designation    String?
  salary         Float?
  visaExpiry     DateTime?
  passportExpiry DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  attendances    Attendance[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payrollRecords PayrollRecord[]
}

model Attendance {
  id         String   @id @default(cuid())
  employeeId String
  date       DateTime
  status     String
  hours      Float?
  jobLink    Json?
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model PayrollRecord {
  id          String   @id @default(cuid())
  employeeId  String
  month       Int
  year        Int
  basicSalary Float
  overtime    Float?
  allowances  Float?
  deductions  Float?
  netPay      Float
  generatedAt DateTime @default(now())
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model MaterialRequest {
  id             String          @id @default(cuid())
  tenantId       String
  requestNumber  String          @unique
  projectId      String?
  subGroupId     String?
  requestedBy    String
  requestedDate  DateTime        @default(now())
  status         String // REQUESTED | QUOTED | PO_CREATED | CANCELLED
  notes          String?
  items          Json // [{ itemName, itemId?, qty, unit, systemItem }]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project        Project?        @relation(fields: [projectId], references: [id])
  subGroup       SubGroup?       @relation(fields: [subGroupId], references: [id])
  vendorQuotes   VendorQuote[]
  purchaseOrders PurchaseOrder[]
}

model Vendor {
  id                    String                 @id @default(cuid())
  tenantId              String
  name                  String
  companyName           String?
  contactPerson         String?
  email                 String?
  email2                String?
  phone                 String?
  phone2                String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  zipCode               String?
  vatNumber             String?
  gstin                 String?
  panNumber             String?
  taxId                 String?
  website               String?
  registrationNumber    String?
  bankDetails           Json?
  paymentTerms          String?
  creditLimit           Float?
  notes                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendorQuotes          VendorQuote[]
  purchaseOrders        PurchaseOrder[]
  subcontractWorkOrders SubcontractWorkOrder[]
}

model VendorQuote {
  id                String          @id @default(cuid())
  tenantId          String
  materialRequestId String
  vendorId          String
  quoteNumber       String
  quotedBy          String?
  lines             Json // [{ description, itemId, qty, unitRate, leadTimeDays }]
  totalAmount       Float
  status            String // SUBMITTED | EXPIRED | REJECTED
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id], onDelete: Cascade)
  vendor            Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model SubcontractWorkOrder {
  id             String    @id @default(cuid())
  tenantId       String
  swoNumber      String    @unique
  vendorId       String
  projectId      String?
  subGroupId     String?
  totalAmount    Float
  materialIssued Json?
  status         String
  createdAt      DateTime  @default(now())
  project        Project?  @relation(fields: [projectId], references: [id])
  subGroup       SubGroup? @relation(fields: [subGroupId], references: [id])
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendor         Vendor    @relation(fields: [vendorId], references: [id])
}

model Document {
  id         String   @id @default(cuid())
  tenantId   String
  entityType String
  entityId   String
  fileName   String
  fileUrl    String
  version    Int      @default(1)
  uploadedBy String
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String?
  userId     String?
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  timestamp  DateTime @default(now())
  tenant     Tenant?  @relation(fields: [tenantId], references: [id])
}

enum Role {
  SUPERADMIN
  DIRECTOR
  SALES
  ESTIMATOR
  PROJECT_MANAGER
  PROCUREMENT
  STOREKEEPER
  PRODUCTION
  QC
  DISPATCH
  FINANCE
  HR
  SUBCONTRACT
  DOCUMENT_CONTROLLER
  IT_ADMIN
}
